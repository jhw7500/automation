name: 'ðŸ”€ Gemini Dispatch'

on:
  workflow_call:
    inputs:
      force_run:
        description: 'Run even if disabled in workflow-config.yml'
        type: boolean
        required: false
        default: false

defaults:
  run:
    shell: 'bash'

jobs:
  check-enabled:
    name: Check if enabled
    runs-on: ubuntu-latest
    outputs:
      enabled: ${{ steps.check.outputs.enabled }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github

      - name: Check workflow config
        id: check
        uses: jhw7500/automation/.github/actions/check-workflow-enabled@v1.1
        with:
          workflow-name: gemini-dispatch
          force-run: ${{ inputs.force_run && 'true' || 'false' }}

  debugger:
    needs: check-enabled
    if: |-
      needs.check-enabled.outputs.enabled == 'true' && (vars.GEMINI_DEBUG == 'true' || vars.ACTIONS_STEP_DEBUG == 'true')
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
    steps:
      - name: 'Print context for debugging'
        env:
          DEBUG_event_name: '${{ github.event_name }}'
          DEBUG_event__action: '${{ github.event.action }}'
          DEBUG_event__comment__author_association: '${{ github.event.comment.author_association }}'
          DEBUG_event__issue__author_association: '${{ github.event.issue.author_association }}'
          DEBUG_event__pull_request__author_association: '${{ github.event.pull_request.author_association }}'
          DEBUG_event__review__author_association: '${{ github.event.review.author_association }}'
          DEBUG_event: '${{ toJSON(github.event) }}'
        run: |-
          env | grep '^DEBUG_'

  dispatch:
    needs: check-enabled
    if: needs.check-enabled.outputs.enabled == 'true'
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
      issues: 'write'
      pull-requests: 'write'
    outputs:
      command: '${{ steps.extract_command.outputs.command }}'
      request: '${{ steps.extract_command.outputs.request }}'
      additional_context: '${{ steps.extract_command.outputs.additional_context }}'
      issue_number: '${{ github.event.pull_request.number || github.event.issue.number }}'
      review_enabled: '${{ steps.check_config.outputs.review_enabled }}'
      triage_enabled: '${{ steps.check_config.outputs.triage_enabled }}'
      invoke_enabled: '${{ steps.check_config.outputs.invoke_enabled }}'
    steps:
      - name: 'Checkout for config'
        uses: 'actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8' # ratchet:actions/checkout@v5
        with:
          sparse-checkout: .github

      - name: 'Check workflow config'
        id: 'check_config'
        run: |-
          CONFIG_FILE=".github/workflow-config.yml"

          get_enabled() {
            local workflow="$1"
            if [[ -f "$CONFIG_FILE" ]]; then
              grep -A1 "^  ${workflow}:" "$CONFIG_FILE" | grep "enabled:" | sed 's/.*enabled: *//' | tr -d ' ' || echo "true"
            else
              echo "true"
            fi
          }

          echo "review_enabled=$(get_enabled 'gemini-review')" >> $GITHUB_OUTPUT
          echo "triage_enabled=$(get_enabled 'gemini-triage')" >> $GITHUB_OUTPUT
          echo "invoke_enabled=$(get_enabled 'gemini-invoke')" >> $GITHUB_OUTPUT

      - name: 'Mint identity token'
        id: 'mint_identity_token'
        if: |-
          ${{ vars.APP_ID }}
        uses: 'actions/create-github-app-token@a8d616148505b5069dccd32f177bb87d7f39123b' # ratchet:actions/create-github-app-token@v2
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'
          permission-contents: 'read'
          permission-issues: 'write'
          permission-pull-requests: 'write'

      - name: 'Extract command'
        id: 'extract_command'
        uses: 'actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea' # ratchet:actions/github-script@v7
        with:
          script: |
            const eventType = `${context.eventName}.${context.payload.action || ''}`;
            const request =
              context.payload?.comment?.body ??
              context.payload?.review?.body ??
              context.payload?.issue?.body ??
              '';

            core.setOutput('request', request);

            if (eventType === 'pull_request.opened') {
              core.setOutput('command', 'review');
            } else if (['issues.opened', 'issues.reopened'].includes(eventType)) {
              core.setOutput('command', 'triage');
            } else if (request.startsWith("@gemini-cli /review")) {
              core.setOutput('command', 'review');
              const additionalContext = request.replace(/^@gemini-cli \/review/, '').trim();
              core.setOutput('additional_context', additionalContext);
            } else if (request.startsWith("@gemini-cli /triage")) {
              core.setOutput('command', 'triage');
            } else if (request.startsWith("@gemini-cli")) {
              const additionalContext = request.replace(/^@gemini-cli/, '').trim();
              core.setOutput('command', 'invoke');
              core.setOutput('additional_context', additionalContext);
            } else {
              core.setOutput('command', 'noop');
            }

      - name: 'Acknowledge request'
        if: steps.extract_command.outputs.command != 'noop'
        env:
          GITHUB_TOKEN: '${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}'
          ISSUE_NUMBER: '${{ github.event.pull_request.number || github.event.issue.number }}'
          MESSAGE: |-
            ðŸ¤– Hi @${{ github.actor }}, I've received your request, and I'm working on it now! You can track my progress [in the logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.
          REPOSITORY: '${{ github.repository }}'
        run: |-
          gh issue comment "${ISSUE_NUMBER}" \
            --body "${MESSAGE}" \
            --repo "${REPOSITORY}"

  skipped:
    name: Workflow Skipped
    needs: check-enabled
    if: needs.check-enabled.outputs.enabled != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Notice
        run: |
          echo "::notice::Gemini Dispatch workflow is disabled in .github/workflow-config.yml"
          echo "## Workflow Skipped" >> $GITHUB_STEP_SUMMARY
          echo "Gemini Dispatch is disabled in workflow-config.yml" >> $GITHUB_STEP_SUMMARY
